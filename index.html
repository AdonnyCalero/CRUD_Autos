<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Autos</title>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="node_modules/sweetalert2/dist/sweetalert2.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Gestión de Autos</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="autoForm">
                    <input type="hidden" id="placaOriginal">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="placa" class="form-label">Placa</label>
                            <input type="text" class="form-control" id="placa" maxlength="8" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modelo" class="form-label">Modelo</label>
                            <input type="text" class="form-control" id="modelo" maxlength="50" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" maxlength="30" pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="correo" class="form-label">Correo del Propietario</label>
                            <input type="email" class="form-control" id="correo" maxlength="100" required>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
                        <button type="button" class="btn btn-success" id="btnActualizar" style="display:none;">Actualizar</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelar" style="display:none;">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="btnSalir">Salir</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h4>Lista de Autos</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Modelo</th>
                            <th>Color</th>
                            <th>Correo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAutos"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/sweetalert2/dist/sweetalert2.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api/autos';

        document.getElementById('autoForm').addEventListener('submit', guardarAuto);
        document.getElementById('btnActualizar').addEventListener('click', actualizarAuto);
        document.getElementById('btnCancelar').addEventListener('click', limpiarFormulario);
        document.getElementById('btnSalir').addEventListener('click', async () => {
            const result = await Swal.fire({
                title: '¿Salir?',
                text: '¿Desea salir de la aplicación?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, salir',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                window.close();
            }
        });

        document.getElementById('color').addEventListener('input', function(e) {
            this.value = this.value.replace(/[0-9]/g, '');
        });

        document.getElementById('placa').addEventListener('input', function(e) {
            let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length >= 3 && !value.includes('-')) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            }
            this.value = value;
        });

        const provinciasValidas = ['A', 'B', 'C', 'E', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

        function validarPlaca(placa) {
            const letraInicial = placa.charAt(0).toUpperCase();
            if (!provinciasValidas.includes(letraInicial)) {
                return false;
            }
            const formatoAntiguo = /^[A-Z]{3}-\d{3}$/;
            const formatoNuevo = /^[A-Z]{3}-\d{4}$/;
            const formatoMoto = /^[A-Z]{2}-\d{4}[A-Z]$/;
            return formatoAntiguo.test(placa) || formatoNuevo.test(placa) || formatoMoto.test(placa);
        }

        function validarCorreo(correo) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
        }

        async function validarCorreoExistente(correo) {
            const dominiosComunes = ['gmail.com', 'hotmail.com', 'outlook.com', 'yahoo.com', 'live.com', 'icloud.com', 'mail.com', 'protonmail.com', 'yahoo.es', 'hotmail.es', 'outlook.es'];
            const dominio = correo.split('@')[1];
            
            if (dominiosComunes.includes(dominio)) {
                return true;
            }
            
            try {
                const response = await fetch(`https://dns.google/resolve?name=${dominio}&type=A`);
                const data = await response.json();
                return data.Answer !== undefined;
            } catch (error) {
                return false;
            }
        }

        async function guardarAuto(e) {
            e.preventDefault();
            const placa = document.getElementById('placa').value.toUpperCase();
            const modelo = document.getElementById('modelo').value.toUpperCase();
            const color = document.getElementById('color').value.toUpperCase();
            const correo = document.getElementById('correo').value.toLowerCase();

            if (!validarPlaca(placa)) {
                Swal.fire('Error', 'Placa inválida. La primera letra debe corresponder a una provincia válida de Ecuador. Formatos: ABC-123 (antiguo), AAA-1234 (nuevo), AA-1234A (moto)', 'error');
                return;
            }

            if (!validarCorreo(correo)) {
                Swal.fire('Error', 'Correo inválido', 'error');
                return;
            }

            Swal.fire({
                title: 'Validando correo...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const correoValido = await validarCorreoExistente(correo);
            Swal.close();

            if (!correoValido) {
                Swal.fire('Error', 'El dominio del correo no existe', 'error');
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ placa, modelo, color, correo })
                });

                if (response.ok) {
                    Swal.fire('Éxito', 'Auto guardado correctamente', 'success');
                    cargarAutos();
                    limpiarFormulario();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'Error al guardar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }

        async function cargarAutos() {
            try {
                const response = await fetch(API_URL);
                const autos = await response.json();
                const tbody = document.getElementById('tablaAutos');
                tbody.innerHTML = '';

                autos.forEach(auto => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${auto.placa}</td>
                        <td>${auto.modelo}</td>
                        <td>${auto.color}</td>
                        <td>${auto.correo}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editarAuto('${auto.placa}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarAuto('${auto.placa}')">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function editarAuto(placa) {
            try {
                const response = await fetch(`${API_URL}/${placa}`);
                const auto = await response.json();

                document.getElementById('placa').value = auto.placa;
                document.getElementById('placaOriginal').value = auto.placa;
                document.getElementById('modelo').value = auto.modelo;
                document.getElementById('color').value = auto.color;
                document.getElementById('correo').value = auto.correo;

                document.getElementById('btnGuardar').style.display = 'none';
                document.getElementById('btnActualizar').style.display = 'inline-block';
                document.getElementById('btnCancelar').style.display = 'inline-block';
            } catch (error) {
                Swal.fire('Error', 'Error al obtener datos del auto', 'error');
            }
        }

        async function actualizarAuto() {
            const placaOriginal = document.getElementById('placaOriginal').value;
            const placa = document.getElementById('placa').value.toUpperCase();
            const modelo = document.getElementById('modelo').value.toUpperCase();
            const color = document.getElementById('color').value.toUpperCase();
            const correo = document.getElementById('correo').value.toLowerCase();

            if (!validarPlaca(placa)) {
                Swal.fire('Error', 'Placa inválida. La primera letra debe corresponder a una provincia válida de Ecuador. Formatos: ABC-123 (antiguo), AAA-1234 (nuevo), AA-1234A (moto)', 'error');
                return;
            }

            if (!validarCorreo(correo)) {
                Swal.fire('Error', 'Correo inválido', 'error');
                return;
            }

            Swal.fire({
                title: 'Validando correo...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const correoValido = await validarCorreoExistente(correo);
            Swal.close();

            if (!correoValido) {
                Swal.fire('Error', 'El dominio del correo no existe', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/${placaOriginal}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ placa, modelo, color, correo })
                });

                if (response.ok) {
                    Swal.fire('Éxito', 'Auto actualizado correctamente', 'success');
                    cargarAutos();
                    limpiarFormulario();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'Error al actualizar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }

        async function eliminarAuto(placa) {
            const result = await Swal.fire({
                title: '¿Está seguro?',
                text: '¿Desea eliminar este auto?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`${API_URL}/${placa}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    Swal.fire('Eliminado', 'Auto eliminado correctamente', 'success');
                    cargarAutos();
                } else {
                    Swal.fire('Error', 'Error al eliminar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }

        function limpiarFormulario() {
            document.getElementById('autoForm').reset();
            document.getElementById('placaOriginal').value = '';
            document.getElementById('btnGuardar').style.display = 'inline-block';
            document.getElementById('btnActualizar').style.display = 'none';
            document.getElementById('btnCancelar').style.display = 'none';
        }

        cargarAutos();
    </script>
</body>
</html>
